DEFAULT_GAMMA = Math.pow(2, 1/32); // doubles every 32 items

const calculateWeightedMean = (arr, gamma = DEFAULT_GAMMA) => {
    if (arr.length === 0) return 0;

    let weightedSum = 0;
    let totalWeight = 0;

    arr.forEach((val, i) => {
        const weight = Math.pow(gamma, i);
        weightedSum += val * weight;
        totalWeight += weight;
    });

    return weightedSum / totalWeight;
}

const calculateWeightedStandardDeviation = (arr, gamma = DEFAULT_GAMMA) => {
    if (arr.length === 0) return 0;

    const mean = calculateWeightedMean(arr, gamma);
    let weightedSquareSum = 0;
    let totalWeight = 0;

    arr.forEach((val, i) => {
        const weight = Math.pow(gamma, i);
        const squareDiff = Math.pow(val - mean, 2);
        weightedSquareSum += squareDiff * weight;
        totalWeight += weight;
    });

    const weightedVariance = weightedSquareSum / totalWeight;
    return Math.sqrt(weightedVariance);
}

const calculateMean = (arr) => calculateWeightedMean(arr, 1);

const calculateStandardDeviation = (arr) => calculateWeightedStandardDeviation(arr, 1);

const Z_SCORE_95 = 1.959963984540054;

const T_SCORES_95 = [0, 12.706204736432095, 4.302652729911275, 3.182446305284263, 2.776445105197799, 2.570581836614739, 2.446911848791681, 2.364624251010299, 2.306004135033370, 2.262157162740992, 2.228138851964939, 2.200985160082949, 2.178812829663418, 2.160368656461013, 2.144786687916927, 2.131449545559323, 2.119905299221011, 2.109815577833181, 2.100922040240960, 2.093024054408263, 2.085963447265836, 2.079613844727662, 2.073873067904015, 2.068657610419041, 2.063898561628021, 2.059538552753294, 2.055529438642871, 2.051830516480283, 2.048407141795244, 2.045229642132703, 2.042272456301237, 2.039513446396408, 2.036933343460101, 2.034515297449338, 2.032244509317718, 2.030107928250342, 2.028094000980450, 2.026192463029109, 2.024394164575136, 2.022690911734728, 2.021075382995337, 2.019540963982894, 2.018081697095881, 2.016692194142813, 2.015367569912941, 2.014103384833292, 2.012895595294589, 2.011740510475755, 2.010634754696445, 2.009575234489209, 2.008559109715206, 2.007583768155882, 2.006646803102211, 2.005745993536950, 2.004879286566523, 2.004044781810181, 2.003240717496698, 2.002465458054599, 2.001717483012092, 2.000995377048210, 2.000297821058262, 1.999623584114978, 1.998971516222311, 1.998340541772196, 1.997729653625973, 1.997137907752012, 1.996564418359474, 1.996008353475506, 1.995468930919402, 1.994945414632814, 1.994437111329773, 1.993943367434504, 1.993463566278583, 1.992997125532166, 1.992543494846820, 1.992102153689865, 1.991672609352349, 1.991254395114604, 1.990847068555052, 1.990450209989360, 1.990063421028384, 1.989686323244483, 1.989318556936819, 1.988959779987179, 1.988609666798673, 1.988267907310378, 1.987934206081672, 1.987608281440577, 1.987289864690938, 1.986978699373768, 1.986674540578468, 1.986377154300065, 1.986086316838893, 1.985801814239503, 1.985523441765830, 1.985251003409926, 1.984984311431769, 1.984723185927883, 1.984467454426692, 1.984216951508683, 1.983971518449633, 1.983731002885281, 1.983495258495940, 1.983264144709710, 1.983037526422990, 1.982815273737154, 1.982597261710291, 1.982383370123017, 1.982173483257451, 1.981967489688474, 1.981765282086510, 1.981566757031071, 1.981371814834400, 1.981180359374580, 1.980992297937506, 1.980807541067200, 1.980626002423937, 1.980447598649729, 1.980272249240706, 1.980099876426006, 1.979930405052777, 1.979763762476930, 1.979599878459331, 1.979438685067090, 1.979280116579683, 1.979124109399617, 1.978970601967393, 1.978819534680521, 1.978670849816362, 1.978524491458605, 1.978380405427153, 1.978238539211258, 1.978098841905723, 1.977961264150001, 1.977825758070053, 1.977692277222804, 1.977560776543083, 1.977431212292894, 1.977303542012916, 1.977177724476122, 1.977053719643388, 1.976931488621022, 1.976810993620089, 1.976692197917468, 1.976575065818536, 1.976459562621416, 1.976345654582700, 1.976233308884588, 1.976122493603363, 1.976013177679155, 1.975905330886914, 1.975798923808550, 1.975693927806186, 1.975590314996458, 1.975488058225832, 1.975387131046878, 1.975287507695472, 1.975189163068866, 1.975092072704601, 1.974996212760225, 1.974901559993772, 1.974808091744976, 1.974715785917188, 1.974624620959958, 1.974534575852265, 1.974445630086359, 1.974357763652185, 1.974270957022384, 1.974185191137821, 1.974100447393633, 1.974016707625782, 1.973933954098069, 1.973852169489613, 1.973771336882769, 1.973691439751456, 1.973612461949897, 1.973534387701743, 1.973457201589564, 1.973380888544703, 1.973305433837466, 1.973230823067649, 1.973157042155369, 1.973084077332216, 1.973011915132679, 1.972940542385869, 1.972869946207499, 1.972800113992135, 1.972731033405690, 1.972662692378165, 1.972595079096615, 1.972528181998345, 1.972461989764315, 1.972396491312759, 1.972331675793001, 1.972267532579456, 1.972204051265833, 1.972141221659497, 1.972079033776022, 1.972017477833895, 1.971956544249395, 1.971896223631609, 1.971836506777615, 1.971777384667801, 1.971718848461318, 1.971660889491678, 1.971603499262478, 1.971546669443243, 1.971490391865397, 1.971434658518350, 1.971379461545699, 1.971324793241529, 1.971270646046835, 1.971217012546033, 1.971163885463576, 1.971111257660664, 1.971059122132044, 1.971007472002907, 1.970956300525859, 1.970905601077990, 1.970855367158011, 1.970805592383475, 1.970756270488079, 1.970707395319028, 1.970658960834481, 1.970610961101059, 1.970563390291422, 1.970516242681912, 1.970469512650255, 1.970423194673329, 1.970377283324986, 1.970331773273933, 1.970286659281669, 1.970241936200475, 1.970197598971455, 1.970153642622630, 1.970110062267077, 1.970066853101121, 1.970024010402567, 1.969981529528981, 1.969939405916016, 1.969897635075768, 1.969856212595194, 1.969815134134551, 1.969774395425879, 1.969733992271528, 1.969693920542713, 1.969654176178106, 1.969614755182469, 1.969575653625311, 1.969536867639582, 1.969498393420400, 1.969460227223805, 1.969422365365546, 1.969384804219894, 1.969347540218486, 1.969310569849193, 1.969273889655019, 1.969237496233022, 1.969201386233261, 1.969165556357771, 1.969130003359555, 1.969094724041605, 1.969059715255944, 1.969024973902692, 1.968990496929144, 1.968956281328883, 1.968922324140902, 1.968888622448752, 1.968855173379707, 1.968821974103945, 1.968789021833752, 1.968756313822743, 1.968723847365097, 1.968691619794810, 1.968659628484969, 1.968627870847033, 1.968596344330141, 1.968565046420423, 1.968533974640334, 1.968503126548004, 1.968472499736592, 1.968442091833664, 1.968411900500578, 1.968381923431890, 1.968352158354758, 1.968322603028376, 1.968293255243406, 1.968264112821431, 1.968235173614414, 1.968206435504172, 1.968177896401857, 1.968149554247451, 1.968121407009270, 1.968093452683482, 1.968065689293623, 1.968038114890140, 1.968010727549932, 1.967983525375898, 1.967956506496507, 1.967929669065362, 1.967903011260784, 1.967876531285397, 1.967850227365727, 1.967824097751799, 1.967798140716761, 1.967772354556490, 1.967746737589230, 1.967721288155221, 1.967696004616341, 1.967670885355754, 1.967645928777568, 1.967621133306495, 1.967596497387521, 1.967572019485577, 1.967547698085226, 1.967523531690346, 1.967499518823825, 1.967475658027258, 1.967451947860655, 1.967428386902150, 1.967404973747713, 1.967381707010879, 1.967358585322468, 1.967335607330316, 1.967312771699017, 1.967290077109658, 1.967267522259571, 1.967245105862078, 1.967222826646251, 1.967200683356668, 1.967178674753181, 1.967156799610681, 1.967135056718873, 1.967113444882052, 1.967091962918884, 1.967070609662189, 1.967049383958733, 1.967028284669017, 1.967007310667077, 1.966986460840278, 1.966965734089124, 1.966945129327058, 1.966924645480279, 1.966904281487548, 1.966884036300012, 1.966863908881018, 1.966843898205941, 1.966824003262005, 1.966804223048118, 1.966784556574698, 1.966765002863512, 1.966745560947514, 1.966726229870682, 1.966707008687866, 1.966687896464628, 1.966668892277099, 1.966649995211822, 1.966631204365608, 1.966612518845396, 1.966593937768107, 1.966575460260506, 1.966557085459066, 1.966538812509834, 1.966520640568296, 1.966502568799249, 1.966484596376675, 1.966466722483609, 1.966448946312024, 1.966431267062699, 1.966413683945109, 1.966396196177300, 1.966378802985776, 1.966361503605385, 1.966344297279209, 1.966327183258447, 1.966310160802313, 1.966293229177926, 1.966276387660206, 1.966259635531770, 1.966242972082828, 1.966226396611087, 1.966209908421651, 1.966193506826920, 1.966177191146500, 1.966160960707105, 1.966144814842466, 1.966128752893241, 1.966112774206922, 1.966096878137750, 1.966081064046626, 1.966065331301023, 1.966049679274910, 1.966034107348660, 1.966018614908972, 1.966003201348790, 1.965987866067225, 1.965972608469475, 1.965957427966749, 1.965942323976193, 1.965927295920809, 1.965912343229391, 1.965897465336445, 1.965882661682122, 1.965867931712145, 1.965853274877740, 1.965838690635572, 1.965824178447673, 1.965809737781377, 1.965795368109257, 1.965781068909057, 1.965766839663633, 1.965752679860889, 1.965738588993712, 1.965724566559917, 1.965710612062186, 1.965696725008005, 1.965682904909613, 1.965669151283938, 1.965655463652545, 1.965641841541579, 1.965628284481712, 1.965614792008086, 1.965601363660263, 1.965587998982170, 1.965574697522050, 1.965561458832410, 1.965548282469967, 1.965535167995607, 1.965522114974328, 1.965509122975197, 1.965496191571299, 1.965483320339694, 1.965470508861367, 1.965457756721185, 1.965445063507854, 1.965432428813868, 1.965419852235472, 1.965407333372618, 1.965394871828920, 1.965382467211614, 1.965370119131515, 1.965357827202978, 1.965345591043858, 1.965333410275471, 1.965321284522551, 1.965309213413216, 1.965297196578927, 1.965285233654453, 1.965273324277831, 1.965261468090333, 1.965249664736427, 1.965237913863743, 1.965226215123036, 1.965214568168156, 1.965202972656008, 1.965191428246522, 1.965179934602620, 1.965168491390180, 1.965157098278007, 1.965145754937800, 1.965134461044118, 1.965123216274354, 1.965112020308700, 1.965100872830117, 1.965089773524308, 1.965078722079685, 1.965067718187342, 1.965056761541027, 1.965045851837109, 1.965034988774555, 1.965024172054902, 1.965013401382225, 1.965002676463115, 1.964991997006651, 1.964981362724372, 1.964970773330253, 1.964960228540678, 1.964949728074415, 1.964939271652592, 1.964928858998672, 1.964918489838426, 1.964908163899913, 1.964897880913456, 1.964887640611612, 1.964877442729158, 1.964867287003062, 1.964857173172463, 1.964847100978646, 1.964837070165024, 1.964827080477113, 1.964817131662511, 1.964807223470879, 1.964797355653915, 1.964787527965339, 1.964777740160870, 1.964767991998205, 1.964758283236999, 1.964748613638848, 1.964738982967265, 1.964729390987665, 1.964719837467344, 1.964710322175459, 1.964700844883014, 1.964691405362833, 1.964682003389552, 1.964672638739595, 1.964663311191155, 1.964654020524183, 1.964644766520365, 1.964635548963106, 1.964626367637513, 1.964617222330383, 1.964608112830177, 1.964599038927014, 1.964590000412648, 1.964580997080454, 1.964572028725412, 1.964563095144094, 1.964554196134645, 1.964545331496769, 1.964536501031714, 1.964527704542260, 1.964518941832698, 1.964510212708822, 1.964501516977911, 1.964492854448715, 1.964484224931442, 1.964475628237745, 1.964467064180705, 1.964458532574823, 1.964450033235998, 1.964441565981522, 1.964433130630066, 1.964424727001660, 1.964416354917689, 1.964408014200873, 1.964399704675262, 1.964391426166216, 1.964383178500399, 1.964374961505761, 1.964366775011532, 1.964358618848207, 1.964350492847533, 1.964342396842502, 1.964334330667333, 1.964326294157468, 1.964318287149555, 1.964310309481440, 1.964302360992155, 1.964294441521906, 1.964286550912067, 1.964278689005163, 1.964270855644862, 1.964263050675970, 1.964255273944410, 1.964247525297221, 1.964239804582545, 1.964232111649616, 1.964224446348751, 1.964216808531341, 1.964209198049840, 1.964201614757756, 1.964194058509644, 1.964186529161093, 1.964179026568717, 1.964171550590148, 1.964164101084030, 1.964156677910000, 1.964149280928691, 1.964141910001713, 1.964134564991655, 1.964127245762064, 1.964119952177449, 1.964112684103263, 1.964105441405899, 1.964098223952684, 1.964091031611866, 1.964083864252609, 1.964076721744983, 1.964069603959958, 1.964062510769398, 1.964055442046048, 1.964048397663530, 1.964041377496337, 1.964034381419820, 1.964027409310187, 1.964020461044491, 1.964013536500625, 1.964006635557315, 1.963999758094110, 1.963992903991381, 1.963986073130306, 1.963979265392871, 1.963972480661858, 1.963965718820840, 1.963958979754174, 1.963952263346997, 1.963945569485213, 1.963938898055493, 1.963932248945269, 1.963925622042719, 1.963919017236773, 1.963912434417095, 1.963905873474085, 1.963899334298870, 1.963892816783299, 1.963886320819936, 1.963879846302052, 1.963873393123625, 1.963866961179329, 1.963860550364529, 1.963854160575278, 1.963847791708310, 1.963841443661033, 1.963835116331524, 1.963828809618526, 1.963822523421440, 1.963816257640320, 1.963810012175869, 1.963803786929433, 1.963797581802994, 1.963791396699168, 1.963785231521198, 1.963779086172950, 1.963772960558908, 1.963766854584165, 1.963760768154426, 1.963754701175997, 1.963748653555780, 1.963742625201272, 1.963736616020560, 1.963730625922312, 1.963724654815776, 1.963718702610774, 1.963712769217701, 1.963706854547513, 1.963700958511729, 1.963695081022427, 1.963689221992234, 1.963683381334326, 1.963677558962424, 1.963671754790785, 1.963665968734205, 1.963660200708010, 1.963654450628050, 1.963648718410703, 1.963643003972860, 1.963637307231933, 1.963631628105838, 1.963625966513004, 1.963620322372358, 1.963614695603329, 1.963609086125841, 1.963603493860308, 1.963597918727632, 1.963592360649201, 1.963586819546880, 1.963581295343013, 1.963575787960415, 1.963570297322373, 1.963564823352637, 1.963559365975421, 1.963553925115397, 1.963548500697692, 1.963543092647885, 1.963537700892005, 1.963532325356524, 1.963526965968357, 1.963521622654856, 1.963516295343811, 1.963510983963439, 1.963505688442391, 1.963500408709741, 1.963495144694984, 1.963489896328037, 1.963484663539231, 1.963479446259310, 1.963474244419428, 1.963469057951149, 1.963463886786436, 1.963458730857655, 1.963453590097571, 1.963448464439343, 1.963443353816522, 1.963438258163049, 1.963433177413250, 1.963428111501835, 1.963423060363898, 1.963418023934906, 1.963413002150705, 1.963407994947511, 1.963403002261912, 1.963398024030861, 1.963393060191679, 1.963388110682045, 1.963383175439998, 1.963378254403937, 1.963373347512611, 1.963368454705123, 1.963363575920925, 1.963358711099814, 1.963353860181933, 1.963349023107765, 1.963344199818133, 1.963339390254198, 1.963334594357453, 1.963329812069725, 1.963325043333169, 1.963320288090269, 1.963315546283834, 1.963310817856994, 1.963306102753200, 1.963301400916222, 1.963296712290147, 1.963292036819374, 1.963287374448613, 1.963282725122886, 1.963278088787520, 1.963273465388147, 1.963268854870704, 1.963264257181428, 1.963259672266852, 1.963255100073810, 1.963250540549428, 1.963245993641126, 1.963241459296613, 1.963236937463887, 1.963232428091235, 1.963227931127224, 1.963223446520709, 1.963218974220820, 1.963214514176971, 1.963210066338851, 1.963205630656422, 1.963201207079922, 1.963196795559859, 1.963192396047009, 1.963188008492419, 1.963183632847399, 1.963179269063523, 1.963174917092629, 1.963170576886814, 1.963166248398435, 1.963161931580103, 1.963157626384688, 1.963153332765310, 1.963149050675343, 1.963144780068411, 1.963140520898385, 1.963136273119383, 1.963132036685769, 1.963127811552152, 1.963123597673378, 1.963119395004538, 1.963115203500958, 1.963111023118206, 1.963106853812079, 1.963102695538613, 1.963098548254073, 1.963094411914958, 1.963090286477995, 1.963086171900137, 1.963082068138566, 1.963077975150687, 1.963073892894128, 1.963069821326743, 1.963065760406601, 1.963061710091993, 1.963057670341427, 1.963053641113627, 1.963049622367532, 1.963045614062294, 1.963041616157277, 1.963037628612057, 1.963033651386416, 1.963029684440348, 1.963025727734050, 1.963021781227926, 1.963017844882584, 1.963013918658834, 1.963010002517686, 1.963006096420354, 1.963002200328246, 1.962998314202971, 1.962994438006331, 1.962990571700327, 1.962986715247149, 1.962982868609183, 1.962979031749005, 1.962975204629380, 1.962971387213265, 1.962967579463801, 1.962963781344317, 1.962959992818327, 1.962956213849529, 1.962952444401805, 1.962948684439217, 1.962944933926010, 1.962941192826605, 1.962937461105606, 1.962933738727789, 1.962930025658110, 1.962926321861699, 1.962922627303860, 1.962918941950069, 1.962915265765975, 1.962911598717397, 1.962907940770324, 1.962904291890914, 1.962900652045491, 1.962897021200548, 1.962893399322741, 1.962889786378892, 1.962886182335986, 1.962882587161171, 1.962879000821757, 1.962875423285211, 1.962871854519164, 1.962868294491402, 1.962864743169872, 1.962861200522675, 1.962857666518068, 1.962854141124463, 1.962850624310426, 1.962847116044676, 1.962843616296083, 1.962840125033668, 1.962836642226604, 1.962833167844210, 1.962829701855956, 1.962826244231457, 1.962822794940478, 1.962819353952925, 1.962815921238852, 1.962812496768455, 1.962809080512075, 1.962805672440194, 1.962802272523434, 1.962798880732559, 1.962795497038472, 1.962792121412216, 1.962788753824970, 1.962785394248050, 1.962782042652912, 1.962778699011142, 1.962775363294465, 1.962772035474738, 1.962768715523951, 1.962765403414227, 1.962762099117819, 1.962758802607115, 1.962755513854627, 1.962752232833001, 1.962748959515008, 1.962745693873551, 1.962742435881654, 1.962739185512473, 1.962735942739285, 1.962732707535496, 1.962729479874632, 1.962726259730346, 1.962723047076409, 1.962719841886719, 1.962716644135291, 1.962713453796262, 1.962710270843890, 1.962707095252551, 1.962703926996738, 1.962700766051065, 1.962697612390259, 1.962694465989167, 1.962691326822749, 1.962688194866082, 1.962685070094356, 1.962681952482875, 1.962678842007057, 1.962675738642431, 1.962672642364637, 1.962669553149430, 1.962666470972672, 1.962663395810335, 1.962660327638502, 1.962657266433363, 1.962654212171218, 1.962651164828473, 1.962648124381638, 1.962645090807336, 1.962642064082289, 1.962639044183328, 1.962636031087386, 1.962633024771501, 1.962630025212815, 1.962627032388571, 1.962624046276114, 1.962621066852892, 1.962618094096454, 1.962615127984447, 1.962612168494620, 1.962609215604821, 1.962606269292996, 1.962603329537189, 1.962600396315543, 1.962597469606296, 1.962594549387784, 1.962591635638439, 1.962588728336788, 1.962585827461452, 1.962582932991149, 1.962580044904687, 1.962577163180972, 1.962574287799000, 1.962571418737858, 1.962568555976729, 1.962565699494884, 1.962562849271685, 1.962560005286586, 1.962557167519131, 1.962554335948951, 1.962551510555767, 1.962548691319390, 1.962545878219716, 1.962543071236730, 1.962540270350505, 1.962537475541200, 1.962534686789057, 1.962531904074406, 1.962529127377664, 1.962526356679330, 1.962523591959986, 1.962520833200301, 1.962518080381026, 1.962515333482993, 1.962512592487119, 1.962509857374402, 1.962507128125921, 1.962504404722835, 1.962501687146387, 1.962498975377897, 1.962496269398766, 1.962493569190474, 1.962490874734581, 1.962488186012724, 1.962485503006618, 1.962482825698058, 1.962480154068913, 1.962477488101131, 1.962474827776736, 1.962472173077827, 1.962469523986581, 1.962466880485247, 1.962464242556152, 1.962461610181696, 1.962458983344351, 1.962456362026667, 1.962453746211264, 1.962451135880835, 1.962448531018148, 1.962445931606040, 1.962443337627422, 1.962440749065275, 1.962438165902652, 1.962435588122676, 1.962433015708541, 1.962430448643509, 1.962427886910913, 1.962425330494157, 1.962422779376710, 1.962420233542112, 1.962417692973970, 1.962415157655959, 1.962412627571823, 1.962410102705370, 1.962407583040476, 1.962405068561086, 1.962402559251207, 1.962400055094913, 1.962397556076345, 1.962395062179707, 1.962392573389269, 1.962390089689364, 1.962387611064391, 1.962385137498810, 1.962382668977147, 1.962380205483990, 1.962377747003988, 1.962375293521857, 1.962372845022369, 1.962370401490363, 1.962367962910736, 1.962365529268449, 1.962363100548522, 1.962360676736035, 1.962358257816130, 1.962355843774008, 1.962353434594929, 1.962351030264214, 1.962348630767241, 1.962346236089449, 1.962343846216334, 1.962341461133449, 1.962339080826407];

const extrapolateMeanAndError = (arr, numSamplesToExtrapolate) => {
	if (numSamplesToExtrapolate === 0) return [0, 0];
	if (arr.length === 0) return ['?', '?'];
	
	const degreesOfFreedom = arr.length - 1;
	const mean = calculateWeightedMean(arr);
	const standardDeviation = calculateWeightedStandardDeviation(arr);

	const standardScore = degreesOfFreedom < T_SCORES_95.length ? T_SCORES_95[degreesOfFreedom] : Z_SCORE_95;
	const extrapolatedConfidence = standardScore * standardDeviation * Math.sqrt(numSamplesToExtrapolate);

	return [
		mean * numSamplesToExtrapolate,
		extrapolatedConfidence || '?'
	];
}
